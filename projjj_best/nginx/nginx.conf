events {}

http {

    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;
    limit_req_zone $binary_remote_addr zone=register_limit:10m rate=5r/m;

    server {
        listen 80;
        listen 443 ssl;
        server_name localhost;

        ssl_certificate     /etc/nginx/certs/localhost.crt;
        ssl_certificate_key /etc/nginx/certs/localhost.key;

        # ------------------------
        # Redirect legacy URLs
        # ------------------------
        location = / {
            return 301 /login;
        }

        location = /index.php {
            return 301 /login;
        }

        location = /register/index.php {
            return 301 /register;
        }

        location = /admin.php {
            return 301 /admin;
        }

        location = /dashboard.php {
            return 301 /dashboard;
        }

        # ------------------------
        # Login
        # ------------------------
        location = /login {
            limit_req zone=login_limit burst=10 delay=5;
            proxy_pass http://auth/index.php;
            include /etc/nginx/proxy_params;
        }

        # ------------------------
        # Register
        # ------------------------
        location = /register {
            limit_req zone=register_limit burst=10 delay=5;
            proxy_pass http://register/index.php;
            include /etc/nginx/proxy_params;
        }

        # ------------------------
        # Admin
        # ------------------------
        location = /admin {
            proxy_pass http://auth/admin.php;
            include /etc/nginx/proxy_params;
        }

        # ------------------------
        # Dashboard
        # ------------------------
        location = /dashboard {
            proxy_pass http://auth/dashboard.php;
            include /etc/nginx/proxy_params;
        }

        # ------------------------
        # Static files
        # ------------------------
        location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
            proxy_pass http://auth$request_uri;
            include /etc/nginx/proxy_params;
            expires 30d;
            access_log off;
        }

        # ------------------------
        # ðŸ”¥ ALL PHP ENDPOINTS (FIX)
        # ------------------------
        location ~ \.php$ {
            proxy_pass http://auth$request_uri;
            include /etc/nginx/proxy_params;
        }
        location = /moderator {
    proxy_pass http://auth/moderator.php;
    include /etc/nginx/proxy_params;
}

    }
}
